{% extends "base.html" %}

{% block title %}Pipeline Stage Management{% endblock %}

{% block authenticated_content %}
<div class="fade-in-up">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h1 class="page-title">
            <i class="fas fa-layer-group me-2"></i>Pipeline Stage Management
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('pipeline') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                <span class="d-none d-sm-inline">Back to Pipeline</span>
                <span class="d-inline d-sm-none">Back</span>
            </a>
            <a href="{{ url_for('new_stage') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                <span class="d-none d-sm-inline">Add New Stage</span>
                <span class="d-inline d-sm-none">Add</span>
            </a>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info d-flex align-items-center mb-4" style="border-left: 4px solid #3b82f6; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);">
        <i class="fas fa-info-circle me-3 fa-lg" style="color: #3b82f6;"></i>
        <div>
            <strong>Drag & Drop to Reorder</strong>
            <p class="mb-0 small">The order will affect how stages appear in the pipeline view.</p>
        </div>
    </div>

    <!-- Stages Table Card -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 stages-table" id="stagesTable">
                    <thead>
                        <tr>
                            <th width="40" class="text-center"><i class="fas fa-grip-vertical text-muted"></i></th>
                            <th class="d-none d-md-table-cell">Position</th>
                            <th>Stage Name</th>
                            <th class="d-none d-lg-table-cell">Color</th>
                            <th class="d-none d-xl-table-cell">Description</th>
                            <th>Leads</th>
                            <th width="120">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sortableStages">
                        {% for item in stages %}
                        <tr data-stage-id="{{ item.stage.id }}">
                            <td class="drag-handle text-center" style="cursor: grab;">
                                <i class="fas fa-grip-vertical text-muted"></i>
                            </td>
                            <td class="d-none d-md-table-cell fw-bold text-muted">{{ loop.index }}</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-lg-none" style="width: 20px; height: 20px; background-color: {{ item.stage.color or '#6c757d' }}; border-radius: 4px; flex-shrink: 0;"></div>
                                    <strong class="text-dark">{{ item.stage.name }}</strong>
                                </div>
                            </td>
                            <td class="d-none d-lg-table-cell">
                                <div class="d-flex align-items-center gap-2">
                                    <div style="width: 32px; height: 32px; background-color: {{ item.stage.color or '#6c757d' }}; border-radius: 6px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                                    <code class="text-muted small">{{ item.stage.color or '#6c757d' }}</code>
                                </div>
                            </td>
                            <td class="d-none d-xl-table-cell">
                                <small class="text-muted">{{ item.stage.description or 'No description' }}</small>
                            </td>
                            <td>
                                <span class="badge rounded-pill" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); padding: 6px 12px;">
                                    {{ item.lead_count }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('edit_stage', stage_id=item.stage.id) }}" 
                                       class="btn btn-sm btn-outline-primary"
                                       title="Edit Stage">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if item.lead_count == 0 %}
                                    <form method="POST" action="{{ url_for('delete_stage', stage_id=item.stage.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this stage?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Stage">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-danger" disabled title="Cannot delete stage with leads">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <div class="empty-state">
                                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                                    <p class="fw-bold mb-1">No pipeline stages found</p>
                                    <p class="small">Create your first stage to get started!</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
/* Stages Table Styling */
.stages-table thead {
    background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
}

.stages-table thead th {
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    padding: 1rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stages-table tbody tr {
    transition: all 0.2s ease;
}

.stages-table tbody tr:hover {
    background: linear-gradient(135deg, rgba(236, 72, 153, 0.03) 0%, rgba(168, 85, 247, 0.03) 100%);
}

.stages-table tbody td {
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #f3f4f6;
}

.drag-handle {
    cursor: grab;
    transition: all 0.2s ease;
}

.drag-handle:hover {
    color: var(--elbroz-purple) !important;
    transform: scale(1.2);
}

.drag-handle:active {
    cursor: grabbing;
}

.sortable-ghost {
    opacity: 0.4;
    background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
}

.sortable-drag {
    cursor: grabbing !important;
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3);
}

.empty-state {
    padding: 2rem;
}

/* Page Title Gradient */
.page-title {
    background: var(--elbroz-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    font-size: 2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .page-title {
        font-size: 1.5rem;
    }
    
    .stages-table tbody td,
    .stages-table thead th {
        padding: 0.75rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .page-title {
        font-size: 1.25rem;
    }
    
    .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
}
</style>

<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sortableTable = document.getElementById('sortableStages');
    
    if (sortableTable) {
        new Sortable(sortableTable, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: function(evt) {
                // Get all stage IDs in new order
                const rows = sortableTable.querySelectorAll('tr[data-stage-id]');
                const stageIds = Array.from(rows).map(row => parseInt(row.dataset.stageId));
                
                // Update position numbers in UI
                rows.forEach((row, index) => {
                    const positionCell = row.cells[1];
                    positionCell.textContent = index + 1;
                });
                
                // Send new order to server
                fetch('/api/pipeline/stages/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stage_ids: stageIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Stages reordered successfully!', 'success');
                    } else {
                        showToast(data.message || 'Failed to reorder stages', 'danger');
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Network error. Please try again.', 'danger');
                    location.reload();
                });
            }
        });
    }
    
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
        toast.style.zIndex = '9999';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>
{% endblock %}
